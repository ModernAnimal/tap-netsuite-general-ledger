# tap-netsuite-general-ledger

A [Singer](https://www.singer.io/) tap for extracting NetSuite General Ledger Detail using SuiteQL.

## Overview

This tap extracts GL Detail data from NetSuite via the SuiteQL REST API using OAuth 1.0a authentication. It supports both full refresh and incremental sync modes based on the `lastmodified` field.

## Installation

```bash
pip install tap-netsuite-general-ledger
```

Or install from source:

```bash
git clone https://github.com/ModernAnimal/tap-netsuite-general-ledger.git
cd tap-netsuite-general-ledger
pip install -e .
```

## Configuration

### Required Configuration

- `netsuite_account`: Your NetSuite account ID
- `netsuite_consumer_key`: OAuth consumer key
- `netsuite_consumer_secret`: OAuth consumer secret  
- `netsuite_token_id`: OAuth token ID
- `netsuite_token_secret`: OAuth token secret

### Optional Configuration

- `last_modified_date`: Date for incremental sync (format: `YYYY-MM-DD`). If not provided, performs full refresh.
- `page_size`: Number of records to fetch per API request (default: `5000`)
- `batch_size`: Number of records to process per batch (default: `100000`)

### Sample Configuration

**Full Refresh (all data):**
```json
{
  "netsuite_account": "5665960",
  "netsuite_consumer_key": "your_consumer_key",
  "netsuite_consumer_secret": "your_consumer_secret",
  "netsuite_token_id": "your_token_id",
  "netsuite_token_secret": "your_token_secret",
  "page_size": 5000,
  "batch_size": 100000
}
```

**Incremental Sync (modified records only):**
```json
{
  "netsuite_account": "5665960",
  "netsuite_consumer_key": "your_consumer_key",
  "netsuite_consumer_secret": "your_consumer_secret",
  "netsuite_token_id": "your_token_id",
  "netsuite_token_secret": "your_token_secret",
  "last_modified_date": "2025-03-01",
  "page_size": 5000,
  "batch_size": 100000
}
```

## Usage

### Discovery Mode

Generate a catalog of available streams:

```bash
tap-netsuite-general-ledger --config config.json --discover > catalog.json
```

### Sync Mode

Extract data using the catalog:

```bash
tap-netsuite-general-ledger --config config.json --catalog catalog.json
```

### With State (for incremental syncs)

```bash
tap-netsuite-general-ledger --config config.json --catalog catalog.json --state state.json
```

## Sync Modes

### Full Refresh
When `last_modified_date` is not provided, the tap fetches all GL transactions that meet the posting criteria.

### Incremental Sync
When `last_modified_date` is provided, the tap only fetches records where `tal.lastmodifieddate >= last_modified_date`. This is ideal for:
- Regular scheduled syncs
- Reducing data transfer
- Capturing recent changes only

## Streams

### netsuite_general_ledger_detail

**Key Properties**: `internal_id`, `transaction_id`, `tran_acct_line_id`

**Replication Method**: `FULL_TABLE` or `INCREMENTAL` (based on `last_modified_date`)

**Fields**:

- `posting_period`: Posting period name
- `postingPeriodID`: Posting period ID
- `createdDate`: Date created (datetime)
- `lastmodified`: Last modified date (datetime)
- `posting`: Posting flag
- `approval`: Approval status
- `transaction_date`: Transaction date
- `transactionid`: Transaction ID
- `transAcctLineID`: Transaction accounting line ID
- `internalid`: Internal ID of the transaction
- `entity_name`: Entity name
- `transmemo`: Transaction memo
- `translineMemo`: Transaction line memo
- `transaction_type`: Transaction type
- `acctID`: Account ID
- `accountgroup`: Account group (parent account)
- `department`: Department ID
- `class`: Class ID
- `location`: Location ID
- `debit`: Debit amount
- `credit`: Credit amount
- `net_amount`: Net amount
- `subsidiary`: Subsidiary
- `document_number`: Document number
- `status`: Status

## SuiteQL Query

The tap executes a SuiteQL query that joins:
- `Transaction` table
- `TransactionAccountingLine` table
- `Account` table
- `TransactionLine` table

The query filters for:
- Posted transactions (`t.Posting = 'T'`)
- Posted accounting lines (`tal.Posting = 'T'`)
- Lines with debit or credit amounts
- Optional: Last modified date filter for incremental syncs

## Performance & Memory Management

The tap uses memory-optimized processing with:
- **Pagination**: Fetches data in pages (default: 5000 records per page)
- **Batch Processing**: Processes records in batches (default: 100000 records per batch)
- **Streaming**: Records are processed and released from memory immediately
- **Garbage Collection**: Aggressive memory cleanup between batches

This approach handles large datasets efficiently while minimizing memory usage.

## NetSuite Setup

### Required Permissions

Ensure the authenticating user/role has:
1. Access to Transaction, TransactionAccountingLine, Account, and TransactionLine records
2. SuiteQL query permissions
3. REST Web Services permission
4. OAuth Token-based authentication setup

### OAuth Authentication

1. Create an Integration Record in NetSuite
2. Note the Consumer Key and Consumer Secret
3. Create an Access Token
4. Note the Token ID and Token Secret
5. Use these credentials in your configuration

## Development

Install development dependencies:

```bash
pip install -e ".[dev]"
```

Run tests:

```bash
pytest
```

## License

This project is licensed under the GNU General Public License v3.0 - see the LICENSE file for details.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## Support

For issues and questions:

1. Check the existing issues on GitHub
2. Create a new issue with detailed information
3. Include sample configuration (without credentials)
4. Include relevant log output
